<!doctype html>
<html lang="he" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
<title>S&P ‚Äì Yard Escape v2 (iPad)</title>
<style>
  html, body { margin:0; padding:0; height:100%; background:#0b0a09; color:#ffd9a3; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;}
  #wrap { position:relative; width:100%; max-width:1280px; aspect-ratio:16/9; margin:0 auto; background:#1b140e; border:1px solid #32251b; box-shadow:0 0 40px rgba(0,0,0,.55); }
  canvas { width:100%; height:100%; display:block; background: radial-gradient(60% 80% at 50% 90%, #1f1510, #0b0907); }
  #hud { position:absolute; inset:0; pointer-events:none; }
  .pill { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.45); border:1px solid rgba(255,214,153,.25);
          padding:.35rem .6rem; border-radius:.6rem; font-weight:800; letter-spacing:.02em;}
  #eggs { right:10px; left:auto; }
  #timer { left:50%; transform:translateX(-50%); }
  #title { position:absolute; left:10px; bottom:10px; background:rgba(0,0,0,.45); border:1px solid rgba(255,214,153,.25);
           padding:.35rem .6rem; border-radius:.6rem; font-weight:800; font-size:.9rem; letter-spacing:.02em;}
  #fullscreen { position:absolute; right:10px; bottom:10px; pointer-events:auto; background:rgba(0,0,0,.55); color:#ffd7a0;
                border:1px solid rgba(255,214,153,.35); padding:.45rem .6rem; border-radius:.4rem; font-weight:800; cursor:pointer; }
  #msg { position:absolute; left:50%; bottom:17%; transform:translateX(-50%); background:rgba(0,0,0,.6);
         border:1px solid rgba(255,214,153,.25); padding:.6rem 1rem; border-radius:.6rem; font-weight:800; text-align:center; display:none; pointer-events:auto;}
  /* Touch controls */
  #touch { position:absolute; inset:0; pointer-events:none; }
  .joy { position:absolute; left:24px; bottom:24px; width:160px; height:160px; pointer-events:auto; }
  .base, .stick { position:absolute; left:0; top:0; width:100%; height:100%; border-radius:50%; }
  .base { background:radial-gradient(60% 60% at 50% 50%, rgba(255,255,255,.06), rgba(0,0,0,.05)); border:2px solid rgba(255,214,153,.2); }
  .stick { width:96px; height:96px; left:32px; top:32px; background:radial-gradient(60% 60% at 50% 50%, rgba(255,255,255,.12), rgba(0,0,0,.25)); border:2px solid rgba(255,214,153,.35); border-radius:50%; }
  .btns { position:absolute; right:24px; bottom:28px; display:flex; gap:10px; pointer-events:auto; }
  .btn { width:70px; height:70px; border-radius:16px; background:rgba(0,0,0,.5); border:2px solid rgba(255,214,153,.35);
         display:flex; align-items:center; justify-content:center; color:#ffd7a0; font-weight:900; user-select:none; }
  .btn.small { width:60px; height:60px; border-radius:14px; }
  .legend { position:absolute; right:24px; bottom:120px; color:#eec488; font-size:.8rem; opacity:.85; }
  @media (max-width:860px){ .joy{width:140px;height:140px;} .btn{width:64px;height:64px;} .btn.small{width:56px;height:56px;} }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="1280" height="720"></canvas>
  <div id="hud">
    <div class="pill" id="playerPill">S√ÅNCHEZ</div>
    <div class="pill" id="timer">03:00</div>
    <div class="pill" id="eggs">ü•ö √ó 0</div>
    <div id="title">S&P ‚Äì Yard Escape v2 ‚Ä¢ O=Routes ‚Ä¢ R=Restart</div>
    <button id="fullscreen" title="Fullscreen">‚õ∂</button>
    <div id="msg"></div>
  </div>
  <div id="touch">
    <div class="joy" id="joy">
      <div class="base"></div><div class="stick" id="stick"></div>
    </div>
    <div class="btns">
      <div class="btn small" data-act="swap">SWP</div>
      <div class="btn small" data-act="dash">DASH</div>
      <div class="btn small" data-act="distract">DIST</div>
      <div class="btn" data-act="throw">THROW</div>
      <div class="btn small" data-act="restart">R</div>
    </div>
    <div class="legend">◊ê◊°◊ï◊£ 3üêî + üîë ◊ï◊ê◊ñ ◊ú‚ÄëEXIT ‚ñ∫</div>
  </div>
</div>

<script>
(()=>{
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  const hud = { pill:document.getElementById('playerPill'), eggs:document.getElementById('eggs'), timer:document.getElementById('timer'), msg:document.getElementById('msg') };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
  const keys={};
  addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; if([' ', 'arrowup','arrowdown','arrowleft','arrowright'].includes(e.key)) e.preventDefault(); });
  addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

  // Touch joystick & buttons
  const joy=document.getElementById('joy'), stick=document.getElementById('stick');
  let joyActive=false, joyDx=0, joyDy=0;
  const joyRect=()=>joy.getBoundingClientRect(); const joyMax=48;
  function onJoy(x,y){ const r=joyRect(); const cx=x-r.left, cy=y-r.top; const dx=cx-r.width/2, dy=cy-r.height/2;
    const m=Math.hypot(dx,dy); const a=Math.atan2(dy,dx); const mm=Math.min(joyMax,m);
    stick.style.transform=`translate(${r.width/2 + Math.cos(a)*mm - 48}px, ${r.height/2 + Math.sin(a)*mm - 48}px)`;
    joyDx = (m<10?0:Math.cos(a)*(mm/joyMax)); joyDy=(m<10?0:Math.sin(a)*(mm/joyMax));
  }
  joy.addEventListener('pointerdown',e=>{ joyActive=true; onJoy(e.clientX,e.clientY); e.target.setPointerCapture(e.pointerId); });
  joy.addEventListener('pointermove',e=>{ if(joyActive) onJoy(e.clientX,e.clientY); });
  joy.addEventListener('pointerup',()=>{ joyActive=false; stick.style.transform='translate(32px,32px)'; joyDx=joyDy=0; });
  document.querySelectorAll('.btn').forEach(b=>b.addEventListener('pointerdown',e=>perform(e.currentTarget.dataset.act)));

  // Fullscreen
  document.getElementById('fullscreen').addEventListener('click',()=>{
    const el=document.getElementById('wrap'); const req=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen;
    const exit=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;
    if(document.fullscreenElement||document.webkitFullscreenElement) exit.call(document); else req&&req.call(el);
  });

  // Map walls (houses/fences) ‚Äì rectangles
  const walls = [
    // Left maze
    {x:60,y:120,w:80,h:360},{x:60,y:540,w:260,h:50},{x:240,y:120,w:60,h:260},
    {x:260,y:430,w:80,h:100},{x:150,y:250,w:60,h:140},
    // Middle columns
    {x:430,y:160,w:70,h:320},{x:520,y:420,w:300,h:60},{x:520,y:240,w:120,h:60},
    {x:680,y:160,w:60,h:120},{x:740,y:280,w:60,h:120},
    // Big T obstacle bottom middle
    {x:420,y:520,w:440,h:40},{x:600,y:520,w:40,h:120},
    // Right side maze & porch
    {x:900,y:280,w:200,h:40},{x:900,y:320,w:60,h:160},{x:1040,y:320,w:60,h:160},
    {x:940,y:480,w:220,h:40},{x:1040,y:160,w:60,h:100},
    // Exit corridor
    {x:1160,y:120,w:40,h:220},{x:1120,y:260,w:80,h:40},
    // Extra fences
    {x:350,y:640,w:180,h:20},{x:820,y:600,w:160,h:20},{x:980,y:560,w:180,h:20}
  ];

  // Exit & items
  const exitGate={x:1210,y:140,r:26};
  const key={x:980,y:360,taken:false};
  const chickens=[
    {x:500,y:300,r:13,taken:false},
    {x:700,y:360,r:13,taken:false},
    {x:960,y:520,r:13,taken:false}
  ];

  // Entities
  function mkPlayer(x,y,type){ return {x,y,r:18,type, speed: type==='p'?160:130, dir:0, stun:0};}
  const san=mkPlayer(220,360,'s');   // start near left-middle
  const pen=mkPlayer(80,620,'p');    // bottom-left like sketch
  const state={active:'s', eggs:0, chickens:0, haveKey:false, time:180, over:false, showRoutes:false};

  // NPCs with patrols approximating the sketch
  function mkNPC(path,speed,cone,range,r){ const p=path[0]; return {x:p.x,y:p.y, r:r||22, path, idx:0, speed, cone, range, t:0, stun:0}; }
  const pathBig=[ // central loops
    {x:620,y:220},{x:740,y:220},{x:740,y:340},{x:600,y:340},{x:560,y:260},{x:620,y:220}
  ];
  const pathDona=[ // porch area zig-zag
    {x:920,y:320},{x:920,y:460},{x:980,y:460},{x:980,y:360},{x:1040,y:360},{x:1040,y:460},{x:1100,y:460},{x:1100,y:320},{x:980,y:320}
  ];
  const pathCop=[ // right corridor to exit up/down
    {x:1120,y:520},{x:1220,y:520},{x:1220,y:260},{x:1160,y:260},{x:1160,y:120},{x:1220,y:120},{x:1220,y:260},{x:1120,y:260}
  ];
  const big=mkNPC(pathBig,85,Math.PI/4,180,26);
  const dona=mkNPC(pathDona,95,Math.PI/6,200,22);
  const cop =mkNPC(pathCop,100,Math.PI/5,220,22);

  const eggs=[];

  // Helpers
  const clampVal=(v,a,b)=>Math.max(a,Math.min(b,v));
  const circleRectCollision=(cx,cy,cr, r)=>{
    const nx=clampVal(cx, r.x, r.x+r.w); const ny=clampVal(cy, r.y, r.y+r.h);
    const dx=cx-nx, dy=cy-ny;
    return (dx*dx + dy*dy) <= cr*cr;
  };
  function resolveWalls(obj){
    for(const w of walls){
      if(circleRectCollision(obj.x,obj.y,obj.r,w)){
        const cx=clampVal(obj.x, w.x, w.x+w.w); const cy=clampVal(obj.y, w.y, w.y+w.h);
        const dx=obj.x-cx, dy=obj.y-cy;
        if(Math.abs(dx)<Math.abs(dy)) obj.x = cx + Math.sign(dx)*(obj.r+0.1);
        else obj.y = cy + Math.sign(dy)*(obj.r+0.1);
      }
    }
  }

  function drawMap(){
    const g = ctx.createLinearGradient(0,H,0,0); g.addColorStop(0,'#3a281b'); g.addColorStop(1,'#1b130e'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    for(const w of walls){
      ctx.fillStyle = w.h<=22? '#3a2b1f' : '#2a2019';
      ctx.fillRect(w.x,w.y,w.w,w.h);
      ctx.strokeStyle='#00000055'; ctx.lineWidth=2; ctx.strokeRect(w.x+1,w.y+1,w.w-2,w.h-2);
    }
    ctx.fillStyle='rgba(255,210,135,.35)'; ctx.font='14px sans-serif';
    ctx.fillText('COOPS', 560, 210); ctx.fillText('PORCH', 960, 300); ctx.fillText('ALLEY', 1165, 100);
    ctx.strokeStyle='#c9a86b'; ctx.lineWidth=4; ctx.strokeRect(exitGate.x-24, exitGate.y-24, 48, 48);
    ctx.fillStyle='#e7ca86'; ctx.fillText('EXIT', exitGate.x-16, exitGate.y-30);
    if(state.haveKey){ ctx.fillStyle='#e7ca86'; ctx.fillRect(exitGate.x-10,exitGate.y-10,20,20); }
  }

  // Pixel-art stamps inside circles
  function pixelStamp(type, size){
    const p=ctx; const S=size/11;
    const make=(color,dots)=>{ p.fillStyle=color; for(const [x,y,w=1,h=1] of dots) p.fillRect((x-5.5)*S,(y-5.5)*S,w*S,h*S); };
    if(type==='san'){ make('#20160f',[[-4,-5,9,2]]); make('#9d3b2d',[[-1,3,2,2],[2,3,2,2],[-4,3,2,2]]); make('#fddeaa',[[-2,-2,4,4]]); make('#3b2418',[[-3,0,6,2],[-3,1,6,1]]); make('#c74a2f',[[-5,4,10,2]]); }
    else if(type==='pen'){ make('#20160f',[[-5,-5,11,2]]); make('#b33c2f',[[-4,3,2,2],[0,3,2,2],[4,3,2,2]]); make('#fee0b0',[[-2,-1,4,4]]); make('#7d1e1e',[[-2,1,4,1]]); make('#caa04c',[[-4,4,8,2]]); }
    else if(type==='dona'){ make('#2a2a2a',[[-4,-5,9,2]]); make('#f6d5a6',[[-2,-1,4,4]]); make('#333',[[4,-1,2,4]]); make('#6e8b5f',[[-4,4,8,2]]); }
    else if(type==='cop'){ make('#233956',[[-4,-5,9,2]]); make('#ffd27d',[[0,-4,1,1]]); make('#f2d7ab',[[-2,-1,4,4]]); make('#355b86',[[-4,4,8,2]]); }
    else if(type==='big'){ make('#a43b2d',[[-4,-2,8,8]]); make('#ffcf7d',[[3,0,2,2]]); make('#fff',[[0,-1,1,1]]); }
    else if(type==='ch'){ make('#f8eed6',[[-3,-2,6,6]]); make('#e33',[[3,-2,2,2]]); }
  }
  function drawToken(x,y,r, baseColor, type, active=false){
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle=baseColor; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=active? '#ffe7b6' :'#00000088'; ctx.lineWidth=active?3:2; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
    ctx.save(); ctx.beginPath(); ctx.arc(0,0,r-2,0,Math.PI*2); ctx.clip(); pixelStamp(type, r*1.6); ctx.restore();
    ctx.restore();
  }
  function drawNPC(n, color, type){
    if(state.showRoutes){ ctx.strokeStyle='rgba(255,220,140,.35)'; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(n.path[0].x,n.path[0].y); for(let i=1;i<n.path.length;i++) ctx.lineTo(n.path[i].x,n.path[i].y); ctx.closePath(); ctx.stroke(); ctx.setLineDash([]); }
    ctx.save(); ctx.translate(n.x,n.y); ctx.globalAlpha=0.13; ctx.fillStyle='#ffd27d'; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,n.range, n.t-n.cone, n.t+n.cone); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1; ctx.restore();
    drawToken(n.x,n.y,n.r,color,type,false); if(n.stun>0){ ctx.fillStyle='#fff'; ctx.fillText('üí´', n.x-4, n.y-14); }
  }
  function drawKey(){ if(key.taken) return; ctx.fillStyle='#e7ca86'; ctx.beginPath(); ctx.arc(key.x,key.y,8,0,Math.PI*2); ctx.fill(); ctx.fillRect(key.x+6,key.y-3,14,6); }
  function drawChicken(ch){ if(ch.taken) return; drawToken(ch.x,ch.y,ch.r,'#f0e3c3','ch'); }

  // NPCs
  function mkNPC(path,speed,cone,range,r){ const p=path[0]; return {x:p.x,y:p.y,r:r||22,path,idx:0,speed,cone,range,t:0,stun:0}; }
  // (already defined above) big,dona,cop

  const eggs=[];

  const circleRectCollision=(cx,cy,cr, r)=>{
    const nx=Math.max(r.x, Math.min(cx, r.x+r.w));
    const ny=Math.max(r.y, Math.min(cy, r.y+r.h));
    const dx=cx-nx, dy=cy-ny;
    return (dx*dx + dy*dy) <= cr*cr;
  };

  function resolveWalls(obj){
    for(const w of walls){
      if(circleRectCollision(obj.x,obj.y,obj.r,w)){
        const nx=Math.max(w.x, Math.min(obj.x, w.x+w.w));
        const ny=Math.max(w.y, Math.min(obj.y, w.y+w.h));
        const dx=obj.x-nx, dy=obj.y-ny;
        if(Math.abs(dx) < Math.abs(dy)) obj.x = nx + Math.sign(dx)*(obj.r+0.1); else obj.y = ny + Math.sign(dy)*(obj.r+0.1);
      }
    }
  }

  // Patrol paths again (needed due to tool reset)
  const pathBig=[{x:620,y:220},{x:740,y:220},{x:740,y:340},{x:600,y:340},{x:560,y:260},{x:620,y:220}];
  const pathDona=[{x:920,y:320},{x:920,y:460},{x:980,y:460},{x:980,y:360},{x:1040,y:360},{x:1040,y:460},{x:1100,y:460},{x:1100,y:320},{x:980,y:320}];
  const pathCop=[{x:1120,y:520},{x:1220,y:520},{x:1220,y:260},{x:1160,y:260},{x:1160,y:120},{x:1220,y:120},{x:1220,y:260},{x:1120,y:260}];
  const big=mkNPC(pathBig,85,Math.PI/4,180,26);
  const dona=mkNPC(pathDona,95,Math.PI/6,200,22);
  const cop =mkNPC(pathCop,100,Math.PI/5,220,22);

  function seenBy(n, who){
    if(n.stun>0) return false;
    const ang=Math.atan2(who.y-n.y, who.x-n.x);
    const d=Math.hypot(who.x-n.x, who.y-n.y);
    return d < n.range && Math.abs(((ang - n.t + Math.PI*3)%(Math.PI*2))-Math.PI) < n.cone;
  }

  function follow(n, dt){
    if(n.stun>0){ n.stun-=dt; return; }
    const t=n.path[n.idx]; const a=Math.atan2(t.y-n.y, t.x-n.x);
    n.x+=Math.cos(a)*n.speed*dt; n.y+=Math.sin(a)*n.speed*dt; n.t=a;
    if(Math.hypot(t.x-n.x, t.y-n.y) < 6) n.idx=(n.idx+1)%n.path.length;
    resolveWalls(n);
  }

  function throwEgg(){ const p=state.active==='s'?san:pen; const a=p.dir; eggs.push({x:p.x+Math.cos(a)*p.r,y:p.y+Math.sin(a)*p.r,vx:Math.cos(a)*280,vy:Math.sin(a)*160-120,b:0}); }

  function movePlayer(p, ix, iy, dt){
    if(p.stun>0) p.stun-=dt;
    const mag=Math.hypot(ix,iy);
    if(mag>0){ ix/=mag; iy/=mag; let spd=p.speed*(p.stun>0?0.4:1); if(p===pen && penDash) spd*=1.75; p.x+=ix*spd*dt; p.y+=iy*spd*dt; p.dir=Math.atan2(iy,ix); }
    p.x=clamp(p.x,20,W-20); p.y=clamp(p.y,20,H-20); resolveWalls(p);
  }

  let penDash=false;
  function perform(act){
    if(act==='swap'){ state.active=state.active==='s'?'p':'s'; }
    else if(act==='dash' && state.active==='p'){ penDash=true; setTimeout(()=>penDash=false,200); }
    else if(act==='distract' && state.active==='s'){ const n={x:san.x+Math.cos(san.dir)*40,y:san.y+Math.sin(san.dir)*40,r:52}; [big,dona,cop].forEach(t=>{ if(dist(n,t)<n.r+t.r) t.stun=1.2; }); flash('◊î◊°◊ó◊™ ◊ß◊ô◊ô◊§!'); }
    else if(act==='throw'){ if(state.eggs>0){ throwEgg(); state.eggs--; hud.eggs.textContent=`ü•ö √ó ${state.eggs}`; } }
    else if(act==='restart'){ restart(); }
  }
  canvas.addEventListener('mousedown',()=>perform('throw'));

  function update(dt){
    if(state.over) return;
    state.time-=dt; if(state.time<=0) lose('◊î◊ñ◊û◊ü ◊†◊í◊û◊®!');

    // input vector
    const act = state.active==='s'?san:pen;
    let ix=((keys['a']||keys['arrowleft'])?-1:0)+((keys['d']||keys['arrowright'])?1:0);
    let iy=((keys['w']||keys['arrowup'])?-1:0)+((keys['s']||keys['arrowdown'])?1:0);
    if(keys['q']||keys['tab']){ perform('swap'); keys['q']=keys['tab']=false; }
    if(keys['shift']) perform('dash');
    if(keys['f']) perform('distract');
    ix+=joyDx; iy+=joyDy;
    movePlayer(act, ix, iy, dt);

    // rubber band for other
    const other = act===san?pen:san; const dx=act.x-other.x, dy=act.y-other.y; const d=Math.hypot(dx,dy);
    if(d>260){ other.x += dx/d * 40*dt; other.y += dy/d * 40*dt; resolveWalls(other); }

    // Chickens
    for(const ch of chickens){
      if(ch.taken) continue;
      const d1=Math.hypot(ch.x-act.x, ch.y-act.y);
      if(d1<70){ const a=Math.atan2(ch.y-act.y, ch.x-act.x); ch.x+=Math.cos(a)*36*dt; ch.y+=Math.sin(a)*36*dt; resolveWalls(ch); }
      if(dist(ch,san)<san.r+ch.r+4 || dist(ch,pen)<pen.r+ch.r+4){ ch.taken=true; state.chickens++; state.eggs=Math.min(3,state.eggs+1); hud.eggs.textContent=`ü•ö √ó ${state.eggs}`; flash('◊™◊§◊°◊™ ◊™◊®◊†◊í◊ï◊ú◊™!'); }
    }
    if(!key.taken && (dist(san,key)<28 || dist(pen,key)<28)){ key.taken=true; state.haveKey=true; flash('◊û◊¶◊ê◊†◊ï ◊û◊§◊™◊ó!'); }

    // NPCs
    follow(big,dt); follow(dona,dt); follow(cop,dt);

    const seen = (seenBy(big,san)||seenBy(big,pen)||seenBy(dona,san)||seenBy(dona,pen)||seenBy(cop,san)||seenBy(cop,pen));
    if(seen){ const n=[big,dona,cop].find(n=>seenBy(n,act)); if(n && dist(n,act) < n.r + act.r + 6) lose('◊†◊™◊§◊°◊™!'); }

    // Eggs
    for(let i=eggs.length-1;i>=0;i--){
      const e=eggs[i]; e.vx*=0.99; e.vy+=420*dt; e.x+=e.vx*dt; e.y+=e.vy*dt;
      if(e.y>H-10){ e.y=H-10; e.vx*=0.6; e.vy*=-0.45; e.b++; }
      if(e.b>2 || (Math.abs(e.vx)<5 && Math.abs(e.vy)<5)){ eggs.splice(i,1); continue; }
      [big,dona,cop].forEach(n=>{ if(Math.hypot(e.x-n.x,e.y-n.y)<n.r+6){ n.stun=2.2; eggs.splice(i,1); flash('üí• ◊ë◊ô◊¶◊î ◊§◊í◊¢◊î!'); } });
    }

    // Exit
    const nearGate=(Math.hypot(san.x-exitGate.x, san.y-exitGate.y)<44 && Math.hypot(pen.x-exitGate.x, pen.y-exitGate.y)<44);
    if(nearGate && state.haveKey && state.chickens>=3) win('◊ë◊®◊ó◊™◊ù ◊¢◊ù ◊î◊™◊®◊†◊í◊ï◊ú◊ï◊™!');
  }

  function draw(){
    drawMap();
    drawKey();
    chickens.forEach(drawChicken);
    drawNPC(big,'#b04533','big');
    drawNPC(dona,'#3a6e3f','dona');
    drawNPC(cop,'#355b86','cop');
    drawToken(san.x,san.y,san.r,'#c86b3c','san', state.active==='s');
    drawToken(pen.x,pen.y,pen.r,'#caa04c','pen', state.active==='p');
    eggs.forEach(e=>{ ctx.fillStyle='#f5edd6'; ctx.beginPath(); ctx.arc(e.x,e.y,6,0,Math.PI*2); ctx.fill(); });
  }

  function loop(t){ const now=performance.now(); if(!loop.last) loop.last=now; const dt=Math.min(0.05,(now-loop.last)/1000); loop.last=now; update(dt); draw(); hud.pill.textContent=state.active==='s'?'S√ÅNCHEZ':'PENDEJO'; hud.eggs.textContent=`ü•ö √ó ${state.eggs}`; hud.timer.textContent=fmt(state.time); requestAnimationFrame(loop); }
  function fmt(t){ t=Math.max(0,Math.floor(t)); const m=Math.floor(t/60); const s=(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
  function flash(txt){ hud.msg.textContent=txt; hud.msg.style.display='block'; hud.msg.style.opacity='1'; clearTimeout(flash._t); flash._t=setTimeout(()=>{ hud.msg.style.transition='opacity .35s'; hud.msg.style.opacity='0'; setTimeout(()=>{hud.msg.style.display='none'; hud.msg.style.transition='';},350); },600); }
  function win(txt){ state.over=true; hud.msg.style.display='block'; hud.msg.textContent='‚úÖ '+txt+'  (R ◊ú◊î◊™◊ó◊ú◊î)'; }
  function lose(txt){ state.over=true; hud.msg.style.display='block'; hud.msg.textContent='‚ùå '+txt+'  (R ◊ú◊î◊™◊ó◊ú◊î)'; }
  function restart(){ state.time=180; state.active='s'; state.eggs=0; state.chickens=0; state.haveKey=false; state.over=false;
    san.x=220; san.y=360; pen.x=80; pen.y=620; [big,dona,cop].forEach(n=>{n.idx=0;n.stun=0; const p=n.path[0]; n.x=p.x; n.y=p.y;}); chickens.forEach((c,i)=>{c.taken=false;}); key.taken=false; eggs.length=0; hud.msg.style.display='none'; }
  addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='r') restart(); if(e.key.toLowerCase()==='o'){ state.showRoutes=!state.showRoutes; }});

  restart(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>
